<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Gateway Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 1400px; margin: 0 auto; }
    .grid-full { grid-column: 1 / -1; }
    .card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
    .card h2 { font-size: 14px; text-transform: uppercase; color: #94a3b8; margin-bottom: 12px; letter-spacing: 0.05em; }
    h1 { text-align: center; margin-bottom: 20px; font-size: 24px; }
    h1 span { color: #94a3b8; font-weight: 400; font-size: 14px; }
    .stat-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .stat { background: #0f172a; border-radius: 8px; padding: 12px 16px; flex: 1; min-width: 120px; text-align: center; }
    .stat .value { font-size: 28px; font-weight: 700; }
    .stat .label { font-size: 11px; color: #64748b; margin-top: 4px; }
    .green { color: #4ade80; }
    .red { color: #f87171; }
    .yellow { color: #fbbf24; }
    .blue { color: #60a5fa; }
    .purple { color: #a78bfa; }
    .cyan { color: #22d3ee; }
    button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; }
    button:hover { transform: translateY(-1px); }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-green { background: #22c55e; color: white; }
    .btn-red { background: #ef4444; color: white; }
    .btn-yellow { background: #f59e0b; color: #1e293b; }
    .btn-gray { background: #475569; color: white; }
    .btn-sm { padding: 4px 10px; font-size: 11px; }
    .btn-group { display: flex; gap: 6px; flex-wrap: wrap; margin: 8px 0; }
    .btn-active { outline: 2px solid #60a5fa; outline-offset: 2px; }
    .backend-card { background: #0f172a; border-radius: 8px; padding: 16px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .backend-name { font-weight: 700; font-size: 16px; }
    .backend-meta { display: flex; gap: 16px; align-items: center; font-size: 13px; }
    .circuit-badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .circuit-CLOSED { background: #166534; color: #4ade80; }
    .circuit-OPEN { background: #7f1d1d; color: #f87171; }
    .circuit-HALF_OPEN { background: #78350f; color: #fbbf24; }
    .bar-container { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .bar-label { width: 80px; font-size: 12px; color: #94a3b8; }
    .bar-track { flex: 1; height: 20px; background: #0f172a; border-radius: 4px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; display: flex; align-items: center; padding-left: 8px; font-size: 11px; font-weight: 600; }
    .log-container { max-height: 250px; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
    .log-entry { padding: 4px 8px; border-bottom: 1px solid #1e293b; }
    .log-entry:nth-child(odd) { background: rgba(255,255,255,0.02); }
    select { background: #0f172a; color: #e2e8f0; border: 1px solid #475569; border-radius: 6px; padding: 6px 10px; font-size: 13px; }
    .algo-desc { font-size: 12px; color: #64748b; margin-top: 4px; }
    .burst-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const API = 'http://localhost:4000';

    function App() {
      const [health, setHealth] = useState(null);
      const [logs, setLogs] = useState([]);
      const [burstCount, setBurstCount] = useState(20);
      const [burstRunning, setBurstRunning] = useState(false);
      const [burstResults, setBurstResults] = useState(null);

      const fetchHealth = useCallback(async () => {
        try {
          const res = await fetch(`${API}/gateway/health`);
          const data = await res.json();
          setHealth(data);
        } catch(e) {
          console.error('Health fetch failed:', e);
        }
      }, []);

      useEffect(() => {
        fetchHealth();
        const interval = setInterval(fetchHealth, 2000);
        return () => clearInterval(interval);
      }, [fetchHealth]);

      const addLog = (msg) => {
        setLogs(prev => [{
          time: new Date().toLocaleTimeString(),
          msg,
        }, ...prev].slice(0, 100));
      };

      const switchRateLimiter = async (name) => {
        await fetch(`${API}/gateway/rate-limiter/${name}`, { method: 'POST' });
        addLog(`Switched rate limiter â†’ ${name}`);
        fetchHealth();
      };

      const switchLoadBalancer = async (name) => {
        await fetch(`${API}/gateway/load-balancer/${name}`, { method: 'POST' });
        addLog(`Switched load balancer â†’ ${name}`);
        fetchHealth();
      };

      const toggleBackend = async (name) => {
        const res = await fetch(`${API}/gateway/backend/${name}/toggle`, { method: 'POST' });
        const data = await res.json();
        addLog(`${name} â†’ ${data.healthy ? 'HEALTHY' : 'DOWN'}`);
        fetchHealth();
      };

      const resetCircuit = async (name) => {
        await fetch(`${API}/gateway/circuit/${name}/reset`, { method: 'POST' });
        addLog(`Circuit reset: ${name}`);
        fetchHealth();
      };

      const crashBackend = async (port) => {
        try {
          await fetch(`http://localhost:${port}/admin/crash`, { method: 'POST' });
          addLog(`Toggled crash on port ${port}`);
        } catch(e) {
          addLog(`Cannot reach port ${port} (might already be down)`);
        }
      };

      const resetMetrics = async () => {
        await fetch(`${API}/gateway/metrics/reset`, { method: 'POST' });
        addLog('Metrics reset');
        fetchHealth();
      };

      const runBurst = async () => {
        setBurstRunning(true);
        setBurstResults(null);
        const results = { success: 0, rateLimited: 0, error: 0, times: [] };
        const start = Date.now();

        addLog(`Burst started: ${burstCount} requests`);

        const promises = Array.from({ length: burstCount }, async (_, i) => {
          const t0 = Date.now();
          try {
            const res = await fetch(`${API}/api/users`);
            const elapsed = Date.now() - t0;
            results.times.push(elapsed);
            if (res.status === 200) results.success++;
            else if (res.status === 429) results.rateLimited++;
            else results.error++;
          } catch(e) {
            results.error++;
          }
        });

        await Promise.all(promises);
        const totalTime = Date.now() - start;
        results.totalTime = totalTime;
        results.avgTime = Math.round(results.times.reduce((a,b) => a+b, 0) / results.times.length);

        setBurstResults(results);
        setBurstRunning(false);
        addLog(`Burst done: ${results.success} ok, ${results.rateLimited} limited, ${results.error} errors (${totalTime}ms)`);
        fetchHealth();
      };

      if (!health) return <div style={{textAlign:'center',padding:60}}>Connecting to gateway...</div>;

      const m = health.metrics || {};
      const totalBackendReqs = Object.values(m.byBackend || {}).reduce((a,b) => a + b, 0);

      const algoDescriptions = {
        'fixed-window': 'Counter per time window. Simple but boundary burst problem.',
        'sliding-log': 'Stores every timestamp. Perfectly accurate but memory-heavy.',
        'sliding-counter': 'Weighted average of windows. Best balance. Used by Stripe.',
        'token-bucket': 'Tokens refill steadily. Allows bursts. Used by AWS.',
        'leaky-bucket': 'Queue drains at fixed rate. Smooths traffic. Used by Shopify.',
      };

      const lbDescriptions = {
        'round-robin': 'Simple rotation: A â†’ B â†’ C â†’ A â†’ B â†’ C',
        'weighted-round-robin': 'A gets 3x, B gets 2x, C gets 1x traffic',
        'least-connections': 'Send to server with fewest active requests',
        'ip-hash': 'Same client IP always goes to same server',
        'consistent-hash': 'Hash ring â€” minimal disruption when servers change',
      };

      return (
        <div>
          <h1>ðŸšª API Gateway Dashboard <span>Layer 6</span></h1>

          <div className="grid">
            {/* Stats */}
            <div className="card grid-full">
              <h2>System Stats</h2>
              <div className="stat-row">
                <div className="stat"><div className="value blue">{m.totalRequests || 0}</div><div className="label">Total Requests</div></div>
                <div className="stat"><div className="value green">{m.proxied || 0}</div><div className="label">Proxied</div></div>
                <div className="stat"><div className="value yellow">{m.rateLimited || 0}</div><div className="label">Rate Limited</div></div>
                <div className="stat"><div className="value red">{m.circuitBroken || 0}</div><div className="label">Circuit Broken</div></div>
                <div className="stat"><div className="value red">{m.errors || 0}</div><div className="label">Errors</div></div>
              </div>
              <div style={{display:'flex',gap:8,alignItems:'center'}}>
                <span style={{fontSize:12,color:'#64748b'}}>Pipeline:</span>
                {(health.pipeline || []).map((name, i) => (
                  <span key={name} style={{display:'flex',alignItems:'center',gap:4}}>
                    <span style={{background:'#334155',padding:'3px 8px',borderRadius:4,fontSize:11,fontWeight:600}}>{name}</span>
                    {i < health.pipeline.length - 1 && <span style={{color:'#475569'}}>â†’</span>}
                  </span>
                ))}
              </div>
            </div>

            {/* Rate Limiter */}
            <div className="card">
              <h2>Rate Limiter</h2>
              <div className="btn-group">
                {Object.keys(algoDescriptions).map(name => (
                  <button
                    key={name}
                    className={`btn-sm ${health.rateLimiter === name ? 'btn-blue btn-active' : 'btn-gray'}`}
                    onClick={() => switchRateLimiter(name)}
                  >{name}</button>
                ))}
              </div>
              <div className="algo-desc">{algoDescriptions[health.rateLimiter]}</div>
            </div>

            {/* Load Balancer */}
            <div className="card">
              <h2>Load Balancer</h2>
              <div className="btn-group">
                {Object.keys(lbDescriptions).map(name => (
                  <button
                    key={name}
                    className={`btn-sm ${health.loadBalancer === name ? 'btn-blue btn-active' : 'btn-gray'}`}
                    onClick={() => switchLoadBalancer(name)}
                  >{name}</button>
                ))}
              </div>
              <div className="algo-desc">{lbDescriptions[health.loadBalancer]}</div>
            </div>

            {/* Backends */}
            <div className="card grid-full">
              <h2>Backend Servers</h2>
              {(health.backends || []).map(b => {
                const reqs = b.requests || 0;
                const pct = totalBackendReqs > 0 ? (reqs / totalBackendReqs * 100).toFixed(1) : 0;
                const colors = { 'Backend-A': '#3b82f6', 'Backend-B': '#22c55e', 'Backend-C': '#a78bfa' };

                return (
                  <div className="backend-card" key={b.name}>
                    <div>
                      <div className="backend-name">{b.name} <span style={{color:'#64748b',fontSize:12}}>:{b.port}</span></div>
                      <div style={{marginTop:6}}>
                        <div className="bar-container">
                          <div className="bar-track" style={{width:200}}>
                            <div className="bar-fill" style={{width:`${pct}%`, background: colors[b.name] || '#3b82f6'}}>{reqs > 0 ? `${reqs} (${pct}%)` : ''}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="backend-meta">
                      <span className={`circuit-badge circuit-${b.circuitState}`}>{b.circuitState}</span>
                      <span style={{color: b.healthy ? '#4ade80' : '#f87171', fontWeight: 600}}>{b.healthy ? 'Healthy' : 'Down'}</span>
                      <div style={{display:'flex',gap:4}}>
                        <button className="btn-sm btn-yellow" onClick={() => toggleBackend(b.name)}>Toggle</button>
                        <button className="btn-sm btn-red" onClick={() => crashBackend(b.port)}>Crash</button>
                        <button className="btn-sm btn-gray" onClick={() => resetCircuit(b.name)}>Reset CB</button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Burst Tester */}
            <div className="card">
              <h2>Load Tester</h2>
              <div className="burst-controls">
                <select value={burstCount} onChange={e => setBurstCount(Number(e.target.value))}>
                  <option value={10}>10 requests</option>
                  <option value={20}>20 requests</option>
                  <option value={50}>50 requests</option>
                  <option value={100}>100 requests</option>
                </select>
                <button className="btn-blue" onClick={runBurst} disabled={burstRunning}>
                  {burstRunning ? 'Running...' : 'ðŸš€ Send Burst'}
                </button>
                <button className="btn-gray" onClick={resetMetrics}>Reset Metrics</button>
              </div>
              {burstResults && (
                <div style={{marginTop:12}}>
                  <div className="stat-row">
                    <div className="stat"><div className="value green" style={{fontSize:20}}>{burstResults.success}</div><div className="label">Success</div></div>
                    <div className="stat"><div className="value yellow" style={{fontSize:20}}>{burstResults.rateLimited}</div><div className="label">Rate Limited</div></div>
                    <div className="stat"><div className="value red" style={{fontSize:20}}>{burstResults.error}</div><div className="label">Errors</div></div>
                  </div>
                  <div style={{fontSize:12,color:'#94a3b8',marginTop:4}}>
                    Total: {burstResults.totalTime}ms | Avg response: {burstResults.avgTime}ms
                  </div>
                </div>
              )}
            </div>

            {/* Event Log */}
            <div className="card">
              <h2>Event Log</h2>
              <div className="log-container">
                {logs.length === 0 && <div style={{color:'#475569',padding:20,textAlign:'center'}}>No events yet. Try sending a burst!</div>}
                {logs.map((log, i) => (
                  <div className="log-entry" key={i}>
                    <span style={{color:'#475569'}}>{log.time}</span> {log.msg}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>